---
layout: page
title: Enterprise Goggles.
---

<h2><a name="A-typical-enterprise-problem" class="anchor" href="#A-typical-enterprise-problem">A typical enterprise problem</a></h2>

<p>Based on a gut feel and no real evidence :) apart from my own experience I would say that a large proportion of enterprise applications are essentially just some sort of Extract - Transform - Load for system A to system B.</p>

<p>For the sake of argument, lets say that the requirement for our application is to read data from a <a href="/code/data/lenses/source_data.xml">XML file</a>, apply some transformation (say convert the sizes to a standard size definition S, M, L, XL) and then write it out to another CSV file.</p>

<p>So we can start by defining to functions to convert the sizes</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span class="i">longSizeToShortSize</span> <span class="o">=</span> <span class="k">function</span> 
        | <span class="s">&quot;</span><span class="s">Small</span><span class="s">&quot;</span> <span class="k">-&gt;</span> <span class="s">&quot;</span><span class="s">S</span><span class="s">&quot;</span>
        | <span class="s">&quot;</span><span class="s">Medium</span><span class="s">&quot;</span> <span class="k">-&gt;</span> <span class="s">&quot;</span><span class="s">M</span><span class="s">&quot;</span>
        | <span class="s">&quot;</span><span class="s">Large</span><span class="s">&quot;</span> <span class="k">-&gt;</span> <span class="s">&quot;</span><span class="s">L</span><span class="s">&quot;</span>
        | <span class="s">&quot;</span><span class="s">Extra</span><span class="s"> </span><span class="s">Large</span><span class="s">&quot;</span> <span class="k">-&gt;</span> <span class="s">&quot;</span><span class="s">XL</span><span class="s">&quot;</span>
        | <span class="i">a</span> <span class="k">-&gt;</span> <span class="i">a</span>

    <span class="k">let</span> <span class="i">shortSizeToLongSize</span> <span class="o">=</span> <span class="k">function</span>  
        | <span class="s">&quot;</span><span class="s">S</span><span class="s">&quot;</span> <span class="k">-&gt;</span> <span class="s">&quot;</span><span class="s">Small</span><span class="s">&quot;</span>
        | <span class="s">&quot;</span><span class="s">M</span><span class="s">&quot;</span> <span class="k">-&gt;</span> <span class="s">&quot;</span><span class="s">Medium</span><span class="s">&quot;</span>
        | <span class="s">&quot;</span><span class="s">L</span><span class="s">&quot;</span> <span class="k">-&gt;</span> <span class="s">&quot;</span><span class="s">Large</span><span class="s">&quot;</span>
        | <span class="s">&quot;</span><span class="s">XL</span><span class="s">&quot;</span> <span class="k">-&gt;</span> <span class="s">&quot;</span><span class="s">Extra</span><span class="s"> </span><span class="s">Large</span><span class="s">&quot;</span>
        | <span class="i">a</span> <span class="k">-&gt;</span> <span class="i">a</span></pre>
</td>
</tr>
</table>

<p>Now this is a fairly trivial problem, to solve and there are many ways to do it, for example a one solution might be to use a type provider and a simple CSV File representation do something like the following.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">type</span> <span class="i">Catalog</span> <span class="o">=</span> <span class="i">XmlProvider</span><span class="o">&lt;</span><span class="s">&quot;</span><span class="s">data</span><span class="s">/</span><span class="s">lenses</span><span class="s">/</span><span class="s">source_data</span><span class="s">.</span><span class="s">xml</span><span class="s">&quot;</span><span class="o">&gt;</span>

    <span class="k">let</span> <span class="i">run</span> (<span class="i">path</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs10', 61)" onmouseover="showTip(event, 'fs10', 61)" class="i">string</span>) <span class="o">=</span>  
        <span class="k">let</span> <span class="i">data</span> <span class="o">=</span> <span class="i">Catalog</span><span class="o">.</span><span class="i">Load</span>(<span class="i">path</span>)
        <span class="k">let</span> <span class="i">data</span> <span class="o">=</span> 
            [|
                <span class="k">for</span> <span class="i">product</span> <span class="k">in</span> <span class="i">data</span><span class="o">.</span><span class="i">Products</span> <span class="k">do</span>
                    <span class="k">for</span> <span class="i">catalogItem</span> <span class="k">in</span> <span class="i">product</span><span class="o">.</span><span class="i">CatalogItems</span> <span class="k">do</span>
                    <span class="k">for</span> <span class="i">size</span> <span class="k">in</span> <span class="i">catalogItem</span><span class="o">.</span><span class="i">Sizes</span> <span class="k">do</span>
                        <span class="k">yield</span> [| <span class="i">catalogItem</span><span class="o">.</span><span class="i">ItemNumber</span> 
                                 <span class="i">product</span><span class="o">.</span><span class="i">Description</span> 
                                 <span class="i">catalogItem</span><span class="o">.</span><span class="i">Gender</span>
                                 <span class="i">size</span><span class="o">.</span><span class="i">Description</span>
                                 <span class="i">longSizeToShortSize</span> <span class="i">size</span><span class="o">.</span><span class="i">Description</span>
                                 <span class="i">catalogItem</span><span class="o">.</span><span class="i">Price</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs10', 62)" onmouseover="showTip(event, 'fs10', 62)" class="i">string</span>
                              |]
            |]
        <span class="i">Csv</span><span class="o">.</span><span class="i">Create</span>([|<span class="s">&quot;</span><span class="s">item_no</span><span class="s">&quot;</span>; <span class="s">&quot;</span><span class="s">description</span><span class="s">&quot;</span>; <span class="s">&quot;</span><span class="s">gender</span><span class="s">&quot;</span>; <span class="s">&quot;</span><span class="s">size</span><span class="s">&quot;</span>; <span class="s">&quot;</span><span class="s">short_size</span><span class="s">&quot;</span>; <span class="s">&quot;</span><span class="s">price</span><span class="s">&quot;</span>|],<span class="i">data</span>)</pre>
</td>
</tr>
</table>

<p>which gives us</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="i">item_no</span>,<span class="i">description</span>,<span class="i">gender</span>,<span class="i">size</span>,<span class="i">short_size</span>,<span class="i">price</span>
<span class="i">QWZ5671</span>,<span class="i">FSharp</span> <span class="i">Sweater</span>,<span class="i">Men&#39;s</span>,<span class="i">Medium</span>,<span class="i">M</span>,<span class="n">39.95</span>
<span class="i">QWZ5671</span>,<span class="i">FSharp</span> <span class="i">Sweater</span>,<span class="i">Men&#39;s</span>,<span class="i">Large</span>,<span class="i">L</span>,<span class="n">39.95</span>
<span class="i">RRX9856</span>,<span class="i">FSharp</span> <span class="i">Sweater</span>,<span class="i">Women&#39;s</span>,<span class="i">Small</span>,<span class="i">S</span>,<span class="n">42.50</span>
<span class="i">RRX9856</span>,<span class="i">FSharp</span> <span class="i">Sweater</span>,<span class="i">Women&#39;s</span>,<span class="i">Medium</span>,<span class="i">M</span>,<span class="n">42.50</span>
<span class="i">RRX9856</span>,<span class="i">FSharp</span> <span class="i">Sweater</span>,<span class="i">Women&#39;s</span>,<span class="i">Large</span>,<span class="i">L</span>,<span class="n">42.50</span>
<span class="i">RRX9856</span>,<span class="i">FSharp</span> <span class="i">Sweater</span>,<span class="i">Women&#39;s</span>,<span class="i">Extra</span> <span class="i">Large</span>,<span class="i">XL</span>,<span class="n">42.50</span>
<span class="i">QWZ8976</span>,<span class="i">FSharp</span> <span class="i">T</span><span class="o">-</span><span class="i">Shirt</span>,<span class="i">Men&#39;s</span>,<span class="i">Medium</span>,<span class="i">M</span>,<span class="n">39.95</span>
<span class="i">QWZ8976</span>,<span class="i">FSharp</span> <span class="i">T</span><span class="o">-</span><span class="i">Shirt</span>,<span class="i">Men&#39;s</span>,<span class="i">Large</span>,<span class="i">L</span>,<span class="n">39.95</span>
<span class="i">RRX345</span>,<span class="i">FSharp</span> <span class="i">T</span><span class="o">-</span><span class="i">Shirt</span>,<span class="i">Women&#39;s</span>,<span class="i">Small</span>,<span class="i">S</span>,<span class="n">42.50</span>
<span class="i">RRX345</span>,<span class="i">FSharp</span> <span class="i">T</span><span class="o">-</span><span class="i">Shirt</span>,<span class="i">Women&#39;s</span>,<span class="i">Medium</span>,<span class="i">M</span>,<span class="n">42.50</span>
<span class="i">RRX345</span>,<span class="i">FSharp</span> <span class="i">T</span><span class="o">-</span><span class="i">Shirt</span>,<span class="i">Women&#39;s</span>,<span class="i">Large</span>,<span class="i">L</span>,<span class="n">42.50</span>
<span class="i">RRX345</span>,<span class="i">FSharp</span> <span class="i">T</span><span class="o">-</span><span class="i">Shirt</span>,<span class="i">Women&#39;s</span>,<span class="i">Extra</span> <span class="i">Large</span>,<span class="i">XL</span>,<span class="n">42.50</span></pre>
</td>
</tr>
</table>

<p>this implementation is all well and good for a one off. It works and is maintainable, in the sense that the code is consise and easy to follow. However there are a few issues. Since this is the enterprise, everytime a business process changes or a external regulatory change happens it is likely that the data format is going to change. It would therefore be nice to be able to change the format without having to re-write everything, in fact in enterprises I have seen release times beyond 6 weeks, so ideally we would like to push as much to scripts or configuation as we can. Also some type providers don't deal well with data that isn't in the same format (missing nodes / properties) as the example provided at compile time; Additionally because they are typically erased, reflection is out of the question, so putting the property mapping in a configuration file, is made significantly more complicated. Now of-course we can always introduce some higher-order functions to abstract aways these problems, but this would be specific to this solution. It would be nice to try and solve this in a more general way.</p>

<h2><a name="Introducing-Optics" class="anchor" href="#Introducing-Optics">Introducing Optics</a></h2>

<p>At <a href="https://skillsmatter.com/conferences/7145-f-exchange-2016#program">F# exchange</a>, I got into a couple of conversations around enterprise development and the patterns that I use when developing line of business applications with F#. Typically the discussion focused on the lack of need for patterns. This is mainly due F#'s strong type system and the fact that higher order functions are a <a href="https://www.infoq.com/presentations/fp-design-patterns">pretty powerful abstraction</a>. However one topic that promoted a certain amount of contention was Lenses or more generally Optics.</p>

<p>Now I can't say I am surprised by this there are a couple of reasons why,</p>

<ul>
<li><p><em>Performance</em> - Extra Allocations caused by individually setting properties on records can have a reasonable performace impact when used in time critical code.</p></li>
<li><p><em>No Language Support</em> - Writing lenses for records can be a large overhead and currently there is no language support. Maybe this will happen in the <a href="https://fslang.uservoice.com/forums/245727-f-language/suggestions/6906132-implement-first-class-lensing-lenses-in-f">future</a> who knows??</p></li>
</ul>

<p>With this considered thou, performance is often not so important in the enterprise, and even maintainability is often sacrificed in the aim of making things flexible. Now there is probably an entire other blog post around why this is the case but thats for another day. So what does an optic solution look like to this problem. Well we can first start by defining some Optics over an XML structure accessed using XPATH and one over CSV.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span class="i">xpath</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> (<span class="i">path</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs10', 63)" onmouseover="showTip(event, 'fs10', 63)" class="i">string</span>) <span class="o">:</span> <span class="i">Lens</span><span class="o">&lt;</span><span class="i">XElement</span>, _<span class="o">&gt;</span> <span class="o">=</span> 
        (<span class="k">fun</span> <span class="i">x</span> <span class="k">-&gt;</span> (<span class="i">x</span><span class="o">.</span><span class="i">XPathEvaluate</span>(<span class="i">path</span>) <span class="o">:?&gt;</span> <span class="i">IEnumerable</span>)<span class="o">.</span><span class="i">Cast</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span>()<span class="o">.</span><span class="i">FirstOrDefault</span>()),
        (<span class="k">fun</span> <span class="i">s</span> <span class="i">x</span> <span class="k">-&gt;</span> <span class="i">x</span>)

    <span class="k">let</span> <span class="i">xml</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="i">defaultV</span> <span class="i">path</span> <span class="o">=</span> 
        <span class="k">let</span> <span class="i">getValue</span> <span class="i">defaultV</span> (<span class="i">x</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs27', 64)" onmouseover="showTip(event, 'fs27', 64)" class="i">obj</span>) <span class="o">=</span>
          <span class="k">match</span> <span class="i">x</span> <span class="k">with</span>
          | <span class="k">null</span> <span class="k">-&gt;</span> <span class="i">defaultV</span>
          | <span class="o">:?</span> <span class="i">XAttribute</span> <span class="k">as</span> <span class="i">a</span> <span class="k">-&gt;</span> <span class="i">a</span><span class="o">.</span><span class="i">Value</span>
          | <span class="o">:?</span> <span class="i">XElement</span> <span class="k">as</span> <span class="i">e</span> <span class="k">-&gt;</span> <span class="i">e</span><span class="o">.</span><span class="i">Value</span>
          | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs17', 65)" onmouseover="showTip(event, 'fs17', 65)" class="i">failwithf</span> <span class="s">&quot;</span><span class="s">unable</span><span class="s"> </span><span class="s">to</span><span class="s"> </span><span class="s">get</span><span class="s"> </span><span class="s">value</span><span class="s"> </span><span class="s">on</span><span class="s"> </span><span class="s">%</span><span class="s">O</span><span class="s">&quot;</span> <span class="i">x</span>

        <span class="k">let</span> <span class="i">setValue</span> (<span class="i">x</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs27', 66)" onmouseover="showTip(event, 'fs27', 66)" class="i">obj</span>) <span class="i">v</span> <span class="o">=</span> 
            <span class="k">match</span> <span class="i">x</span> <span class="k">with</span>
            | <span class="o">:?</span> <span class="i">XAttribute</span> <span class="k">as</span> <span class="i">a</span> <span class="k">-&gt;</span> <span class="i">a</span><span class="o">.</span><span class="i">SetValue</span>(<span class="i">v</span>)
            | <span class="o">:?</span> <span class="i">XElement</span> <span class="k">as</span> <span class="i">e</span> <span class="k">-&gt;</span> <span class="i">e</span><span class="o">.</span><span class="i">SetValue</span>(<span class="i">v</span>)
            | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs17', 67)" onmouseover="showTip(event, 'fs17', 67)" class="i">failwithf</span> <span class="s">&quot;</span><span class="s">unable</span><span class="s"> </span><span class="s">to</span><span class="s"> </span><span class="s">set</span><span class="s"> </span><span class="s">value</span><span class="s"> </span><span class="s">%</span><span class="s">O</span><span class="s">&quot;</span> <span class="i">x</span>
            <span onmouseout="hideTip(event, 'fs28', 68)" onmouseover="showTip(event, 'fs28', 68)" class="i">unbox</span><span class="o">&lt;</span>_<span class="o">&gt;</span> <span class="i">x</span>
        
        <span class="k">let</span> <span class="i">l</span> <span class="o">:</span> <span class="i">Lens</span><span class="o">&lt;</span>_,_<span class="o">&gt;</span> <span class="o">=</span> (<span class="k">fun</span> <span class="i">x</span> <span class="k">-&gt;</span> <span class="i">getValue</span> <span class="i">defaultV</span> <span class="i">x</span>), (<span class="k">fun</span> <span class="i">s</span> <span class="i">x</span> <span class="k">-&gt;</span> <span class="i">setValue</span> <span class="i">x</span> <span class="i">s</span>)
        <span class="i">xpath</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="i">path</span> <span class="o">&gt;</span><span class="k">-&gt;</span> <span class="i">l</span>

    <span class="k">let</span> <span class="i">xattr</span> <span class="o">=</span> <span class="i">xml</span><span class="o">&lt;</span><span class="i">XAttribute</span><span class="o">&gt;</span>

    <span class="k">let</span> <span class="i">xelem</span> <span class="o">=</span> <span class="i">xml</span><span class="o">&lt;</span><span class="i">XElement</span><span class="o">&gt;</span> 

    <span class="k">let</span> <span class="i">csv</span> <span class="i">indx</span> (<span class="i">col</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs10', 69)" onmouseover="showTip(event, 'fs10', 69)" class="i">string</span>) <span class="o">:</span> <span class="i">Prism</span><span class="o">&lt;</span><span class="i">Csv</span>, _<span class="o">&gt;</span> <span class="o">=</span>
        (<span class="k">fun</span> <span class="i">x</span> <span class="k">-&gt;</span> <span class="i">x</span><span class="o">.</span><span class="i">GetValue</span>(<span class="i">col</span>,<span class="i">indx</span>)),
        (<span class="k">fun</span> <span class="i">s</span> <span class="i">x</span> <span class="k">-&gt;</span> <span class="i">x</span><span class="o">.</span><span class="i">SetValue</span>(<span class="i">col</span>, <span class="i">indx</span>, <span class="i">s</span>); <span class="i">x</span>)</pre>
</td>
</tr>
</table>

<p>Here I am using <a href="https://github.com/xyncro/aether">Aether</a> a lens library by Andrew Cherry and a simple (CSV file representation)[<a href="https://gist.github.com/colinbull/60797d5377be4d841f51e4f0776a24fa">https://gist.github.com/colinbull/60797d5377be4d841f51e4f0776a24fa</a>] but you could use anything. If you have never used Optics or just simply want a refresher then I might suggest the guide to Aether which can be found (here)[<a href="https://xyncro.tech/aether/guides/">https://xyncro.tech/aether/guides/</a>]. Also after you have read that guide you may notice that I'm not defining Optics per se, instead I'm defining functions that return optics a subtle but important distinction.</p>

<p>Now we have our optics (sorry, functions) we can define our mappings. But first we need to add a little extra to our domain functions, so we can use them with Optics. In terms of transformations there are three things we can compose with Optics. Optics, Isomorphisms (a reversible function e.g. <code>string -&gt; char[]</code> and <code>char[] -&gt; string</code>) and Epimorphisms (which is a weaker version of the Isomorphism in that the left hand conversion may fail e.g. <code>string -&gt; char[] option</code> and <code>char[] -&gt; string</code>). For our little problem we only need to concern ourselves with the former since we have a total function (since we include the unknown mappings). So we can define our isomorphism as follows.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span class="i">shortSize</span> <span class="o">:</span> <span class="i">Isomorphism</span><span class="o">&lt;</span>_,_<span class="o">&gt;</span> <span class="o">=</span> 
        <span class="i">shortSizeToLongSize</span>,
        <span class="i">longSizeToShortSize</span></pre>
</td>
</tr>
</table>

<p>Now we can represent our mappings as a simple list of tuples the first item in the tuple is the optic we shall use to read the data using XPATH, the second item is the optic we shall use to set the data (pop it into our CSV file representation).</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
<span class="l">9: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span class="i">mappings</span> <span class="i">indx</span> <span class="o">=</span>  
        [
           <span class="i">xelem</span> <span class="s">&quot;</span><span class="s">NULL</span><span class="s">&quot;</span> <span class="s">&quot;</span><span class="s">parent</span><span class="s">:</span><span class="s">:</span><span class="s">catalog_item</span><span class="s">/</span><span class="s">item_number</span><span class="s">&quot;</span>, (<span class="i">csv</span> <span class="i">indx</span> <span class="s">&quot;</span><span class="s">item_no</span><span class="s">&quot;</span>)
           <span class="i">xattr</span> <span class="s">&quot;</span><span class="s">NULL</span><span class="s">&quot;</span> <span class="s">&quot;</span><span class="s">ancestor</span><span class="s">:</span><span class="s">:</span><span class="s">product</span><span class="s">/</span><span class="s">@</span><span class="s">description</span><span class="s">&quot;</span>, (<span class="i">csv</span> <span class="i">indx</span> <span class="s">&quot;</span><span class="s">description</span><span class="s">&quot;</span>)
           <span class="i">xattr</span> <span class="s">&quot;</span><span class="s">NULL</span><span class="s">&quot;</span> <span class="s">&quot;</span><span class="s">parent</span><span class="s">:</span><span class="s">:</span><span class="s">catalog_item</span><span class="s">/</span><span class="s">@</span><span class="s">gender</span><span class="s">&quot;</span>, (<span class="i">csv</span> <span class="i">indx</span> <span class="s">&quot;</span><span class="s">gender</span><span class="s">&quot;</span>)
           <span class="i">xattr</span> <span class="s">&quot;</span><span class="s">NULL</span><span class="s">&quot;</span> <span class="s">&quot;</span><span class="s">@</span><span class="s">description</span><span class="s">&quot;</span>, (<span class="i">csv</span> <span class="i">indx</span> <span class="s">&quot;</span><span class="s">size</span><span class="s">&quot;</span>)
           <span class="i">xattr</span> <span class="s">&quot;</span><span class="s">NULL</span><span class="s">&quot;</span> <span class="s">&quot;</span><span class="s">@</span><span class="s">description</span><span class="s">&quot;</span>, (<span class="i">csv</span> <span class="i">indx</span> <span class="s">&quot;</span><span class="s">short_size</span><span class="s">&quot;</span> <span class="o">&gt;</span><span class="o">?&gt;</span> <span class="i">shortSize</span>)
           <span class="i">xelem</span> <span class="s">&quot;</span><span class="s">NULL</span><span class="s">&quot;</span> <span class="s">&quot;</span><span class="s">parent</span><span class="s">:</span><span class="s">:</span><span class="s">catalog_item</span><span class="s">/</span><span class="s">price</span><span class="s">&quot;</span>, (<span class="i">csv</span> <span class="i">indx</span> <span class="s">&quot;</span><span class="s">price</span><span class="s">&quot;</span>)       
        ]</pre>
</td>
</tr>
</table>

<p>Now we have our mappings along with our transformations we need to actually be able to run this code. This is where things get a little bit nasty.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span class="k">inline</span> <span class="i">etl</span> <span class="i">transform</span> <span class="i">load</span> <span class="i">extract</span> <span class="o">=</span> 
        <span class="k">let</span> <span class="k">inline</span> <span class="i">getSet</span> (<span class="i">get</span>,<span onmouseout="hideTip(event, 'fs29', 70)" onmouseover="showTip(event, 'fs29', 70)" class="i">set</span>) <span class="i">load</span> <span class="i">source</span> <span class="o">=</span>
            <span class="k">let</span> <span class="i">value</span> <span class="o">=</span> (<span class="i">Optic</span><span class="o">.</span><span class="i">get</span> <span class="i">get</span> <span class="i">source</span>)
            <span class="i">Optic</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs29', 71)" onmouseover="showTip(event, 'fs29', 71)" class="i">set</span> <span onmouseout="hideTip(event, 'fs29', 72)" onmouseover="showTip(event, 'fs29', 72)" class="i">set</span> <span class="i">value</span> <span class="i">load</span>

        <span class="i">extract</span>()
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs18', 73)" onmouseover="showTip(event, 'fs18', 73)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs30', 74)" onmouseover="showTip(event, 'fs30', 74)" class="i">indexed</span>
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs18', 75)" onmouseover="showTip(event, 'fs18', 75)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs31', 76)" onmouseover="showTip(event, 'fs31', 76)" class="i">fold</span> (<span class="k">fun</span> <span class="i">loader</span> (<span class="i">rowNumber</span>, <span class="i">x</span>) <span class="k">-&gt;</span> 
                        (<span class="i">transform</span> <span class="i">rowNumber</span>)
                        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs18', 77)" onmouseover="showTip(event, 'fs18', 77)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs31', 78)" onmouseover="showTip(event, 'fs31', 78)" class="i">fold</span> (<span class="k">fun</span> <span class="i">loader</span> <span class="i">mapping</span> <span class="k">-&gt;</span> <span class="i">getSet</span> <span class="i">mapping</span> <span class="i">loader</span> <span class="i">x</span>) <span class="i">loader</span>) <span class="i">load</span></pre>
</td>
</tr>
</table>

<p>URRGH!! WTF! But as nasty as this function looks, it is actaully quiet simple; and completely general and only needs to be written once. It simply iterates over the incoming data and applies an index to this data, this represents the row number. We then fold over this indexed data, with each fold we fold over each over the mappings, reading from the first optic supplied by the mappings list then sending the value to the second optic, because of the definition lenses of setting the value means it returns to object the value was applied to, which is then returned by the fold.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span class="i">extract</span>() <span class="o">=</span>
        <span class="k">let</span> <span class="i">path</span> <span class="o">=</span> <span class="k">__SOURCE_DIRECTORY__</span> <span class="o">+</span> <span class="s">&quot;</span><span class="s">/</span><span class="s">data</span><span class="s">/</span><span class="s">lenses</span><span class="s">/</span><span class="s">source_data</span><span class="s">.</span><span class="s">xml</span><span class="s">&quot;</span>
        <span class="i">XDocument</span><span class="o">.</span><span class="i">Load</span>(<span class="i">path</span>)<span class="o">.</span><span class="i">XPathSelectElements</span>(<span class="s">&quot;</span><span class="s">/</span><span class="s">/</span><span class="s">catalog_item</span><span class="s">/</span><span class="s">size</span><span class="s">&quot;</span>)

    <span class="i">etl</span> <span class="i">mappings</span> <span class="i">Csv</span><span class="o">.</span><span class="i">Empty</span> <span class="i">extract</span></pre>
</td>
</tr>
</table>

<p>This returns the same as out original solution which is good,</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="i">item_no</span>,<span class="i">description</span>,<span class="i">gender</span>,<span class="i">size</span>,<span class="i">short_size</span>,<span class="i">price</span>
<span class="i">QWZ5671</span>,<span class="i">FSharp</span> <span class="i">Sweater</span>,<span class="i">Men&#39;s</span>,<span class="i">Medium</span>,<span class="i">M</span>,<span class="n">39.95</span>
<span class="i">QWZ5671</span>,<span class="i">FSharp</span> <span class="i">Sweater</span>,<span class="i">Men&#39;s</span>,<span class="i">Large</span>,<span class="i">L</span>,<span class="n">39.95</span>
<span class="i">RRX9856</span>,<span class="i">FSharp</span> <span class="i">Sweater</span>,<span class="i">Women&#39;s</span>,<span class="i">Small</span>,<span class="i">S</span>,<span class="n">42.50</span>
<span class="i">RRX9856</span>,<span class="i">FSharp</span> <span class="i">Sweater</span>,<span class="i">Women&#39;s</span>,<span class="i">Medium</span>,<span class="i">M</span>,<span class="n">42.50</span>
<span class="i">RRX9856</span>,<span class="i">FSharp</span> <span class="i">Sweater</span>,<span class="i">Women&#39;s</span>,<span class="i">Large</span>,<span class="i">L</span>,<span class="n">42.50</span>
<span class="i">RRX9856</span>,<span class="i">FSharp</span> <span class="i">Sweater</span>,<span class="i">Women&#39;s</span>,<span class="i">Extra</span> <span class="i">Large</span>,<span class="i">XL</span>,<span class="n">42.50</span>
<span class="i">QWZ8976</span>,<span class="i">FSharp</span> <span class="i">T</span><span class="o">-</span><span class="i">Shirt</span>,<span class="i">Men&#39;s</span>,<span class="i">Medium</span>,<span class="i">M</span>,<span class="n">39.95</span>
<span class="i">QWZ8976</span>,<span class="i">FSharp</span> <span class="i">T</span><span class="o">-</span><span class="i">Shirt</span>,<span class="i">Men&#39;s</span>,<span class="i">Large</span>,<span class="i">L</span>,<span class="n">39.95</span>
<span class="i">RRX345</span>,<span class="i">FSharp</span> <span class="i">T</span><span class="o">-</span><span class="i">Shirt</span>,<span class="i">Women&#39;s</span>,<span class="i">Small</span>,<span class="i">S</span>,<span class="n">42.50</span>
<span class="i">RRX345</span>,<span class="i">FSharp</span> <span class="i">T</span><span class="o">-</span><span class="i">Shirt</span>,<span class="i">Women&#39;s</span>,<span class="i">Medium</span>,<span class="i">M</span>,<span class="n">42.50</span>
<span class="i">RRX345</span>,<span class="i">FSharp</span> <span class="i">T</span><span class="o">-</span><span class="i">Shirt</span>,<span class="i">Women&#39;s</span>,<span class="i">Large</span>,<span class="i">L</span>,<span class="n">42.50</span>
<span class="i">RRX345</span>,<span class="i">FSharp</span> <span class="i">T</span><span class="o">-</span><span class="i">Shirt</span>,<span class="i">Women&#39;s</span>,<span class="i">Extra</span> <span class="i">Large</span>,<span class="i">XL</span>,<span class="n">42.50</span></pre>
</td>
</tr>
</table>

<p>and now the mapping is essentially just data. However it is still compiled, so all we have really bought ourselves is turning the mappings into a list. Or have we? Lets have a closer look.</p>

<p>When we defined our lenses and transformations we defined things in a very specific way. The reason for this is for composablility, the lens solution allows us to implement pretty much any mapping and transformation we want without ever changing the overall structure of the solution. If I wanted to for example write this to a .NET datatable rather than CSV file then I create a function that provides, getters and setters to an instance of a datatable replace that with the CSV ones. In addition the Optic over the datatable can then be put as a gist, shared assembly or however you use common code and re-used.</p>

<p>So, what do you think? Are optics worth it? In my opinion apart from the plumbing code <code>etl</code> function (which is written once) the rest of the code is very simple and could be read by anyone, even maybe the business; which at the end of the day is what all enterprise devs try to acheive as it makes, their lives that little bit easier :).</p>

<p><em>Many YAK's have been shorn but none hurt</em></p>


<div class="tip" id="fs1">namespace System</div>
<div class="tip" id="fs2">namespace System.Linq</div>
<div class="tip" id="fs3">namespace System.Collections</div>
<div class="tip" id="fs4">namespace System.Collections.Generic</div>
<div class="tip" id="fs5">namespace System.Xml</div>
<div class="tip" id="fs6">namespace Microsoft.FSharp.Linq</div>
<div class="tip" id="fs7">namespace System.Xml.XPath</div>
<div class="tip" id="fs8">module Operators<br /><br />from Microsoft.FSharp.Core</div>
<div class="tip" id="fs9">namespace Microsoft.FSharp.Data</div>
<div class="tip" id="fs10">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = System.String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs11">type ResizeArray&lt;&#39;T&gt; = System.Collections.Generic.List&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.ResizeArray&lt;_&gt;</div>
<div class="tip" id="fs12">union case Option.Some: Value: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs13">module Array<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs14">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; array:&#39;T [] -&gt; &#39;U []<br /><br />Full name: Microsoft.FSharp.Collections.Array.map</div>
<div class="tip" id="fs15">union case Option.None: Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs16">val defaultArg : arg:&#39;T option -&gt; defaultValue:&#39;T -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.Operators.defaultArg</div>
<div class="tip" id="fs17">val failwithf : format:Printf.StringFormat&lt;&#39;T,&#39;Result&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.failwithf</div>
<div class="tip" id="fs18">module Seq<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs19">val tryItem : index:int -&gt; source:seq&lt;&#39;T&gt; -&gt; &#39;T option<br /><br />Full name: Microsoft.FSharp.Collections.Seq.tryItem</div>
<div class="tip" id="fs20">val tryFindIndex : predicate:(&#39;T -&gt; bool) -&gt; source:seq&lt;&#39;T&gt; -&gt; int option<br /><br />Full name: Microsoft.FSharp.Collections.Seq.tryFindIndex</div>
<div class="tip" id="fs21">module Option<br /><br />from Microsoft.FSharp.Core</div>
<div class="tip" id="fs22">val bind : binder:(&#39;T -&gt; &#39;U option) -&gt; option:&#39;T option -&gt; &#39;U option<br /><br />Full name: Microsoft.FSharp.Core.Option.bind</div>
<div class="tip" id="fs23">val toArray : source:seq&lt;&#39;T&gt; -&gt; &#39;T []<br /><br />Full name: Microsoft.FSharp.Collections.Seq.toArray</div>
<div class="tip" id="fs24">module String<br /><br />from Microsoft.FSharp.Core</div>
<div class="tip" id="fs25">val concat : sep:string -&gt; strings:seq&lt;string&gt; -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.String.concat</div>
<div class="tip" id="fs26">val ignore : value:&#39;T -&gt; unit<br /><br />Full name: Microsoft.FSharp.Core.Operators.ignore</div>
<div class="tip" id="fs27">type obj = System.Object<br /><br />Full name: Microsoft.FSharp.Core.obj</div>
<div class="tip" id="fs28">val unbox : value:obj -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.Operators.unbox</div>
<div class="tip" id="fs29">val set : elements:seq&lt;&#39;T&gt; -&gt; Set&lt;&#39;T&gt; (requires comparison)<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.set</div>
<div class="tip" id="fs30">val indexed : source:seq&lt;&#39;T&gt; -&gt; seq&lt;int * &#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.indexed</div>
<div class="tip" id="fs31">val fold : folder:(&#39;State -&gt; &#39;T -&gt; &#39;State) -&gt; state:&#39;State -&gt; source:seq&lt;&#39;T&gt; -&gt; &#39;State<br /><br />Full name: Microsoft.FSharp.Collections.Seq.fold</div>
